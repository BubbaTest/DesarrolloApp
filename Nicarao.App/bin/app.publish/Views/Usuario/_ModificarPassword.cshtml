@{
    Layout = null;
}
<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Titulo</title>
    @*@Styles.Render("~/Content/css/alertify")*@
    @*@Styles.Render("~/Content/gaia_css/rol.css")*@
    @Styles.Render("~/Content/gaia_css/menu.css")
    @Styles.Render("~/Content/gaia_css/formulario.css")
    @Styles.Render("~/Content/css/alertify")

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/alertify")

    <style>
                * {
                    margin: 0;
                    padding: 0;
                }

                body {
                    background-image: url('../Content/img/bg_header.png');
                    background-repeat: repeat;
                    font-family: "Segoe UI", "Open Sans", sans-serif, serif;
                }

                .titulo {
                    font-size: 50px;
                    color: #ffffff;
                }

                img {
                    margin-left: auto;
                    margin-right: auto;
                    display: block;
                }

                .slider {
                    width: 100%;
                }

                    .slider img {
                        visibility: hidden;
                    }

                #ImgSlides .mySlides {
                    height: 300px;
                }

                .tituloInicio {
                    text-align: center;
                    color: #006AB7;
                    padding: 8px;
                }

                .pie {
                    text-align: center;
                    color: #ffffff;
                    padding: 15px;
                }

                table {
                    width: 100%;
                }

                .mensajeIE {
                    color: #00356a;
                }

                @@media screen and (max-width:1000px) {
                    .divIzquierdo {
                        display: none;
                    }

                    .titulo {
                        font-size: 30px;
                    }

                    .formularioresponsive {
                        margin-left: 100px;
                    }
                }

                /* Estilo Fernando para el input de password */

                .cont-inputpass {
                    position: relative;
                }

                .password {
                    height: 37px;
                    width: 100%;
                }

                .ico {
                    display: none;
                    position: absolute;
                    top: 50%;
                    right: 12px;
                    background: rgba(199, 196, 195,.8);
                    border-radius: 5px;
                    padding: 2px;
                    transform: translate(0%, -50%);
                    -webkit-transform: translate(0%, -50%);
                }

                    .password:hover + .ico, .ico:hover {
                        display: block;
                        cursor: pointer;
                    }

                /* Fin del estilo de fernando para el input de password */


                .cont-inputpass {
                    position: relative;
                }

                .password {
                    height: 37px;
                    width: 100%;
                }

                .ico {
                    display: none;
                    position: absolute;
                    top: 50%;
                    right: 12px;
                    background: #dddddd;
                    border-radius: 8px;
                    padding: 3px;
                    transform: translate(0%, -50%);
                    -webkit-transform: translate(0%, -50%);
                }

                    .password:hover + .ico, .ico:hover {
                        display: block;
                        cursor: pointer;
                    }

                /* Fin del estilo de fernando para el input de password */


                /************
        **TOOLTIPS***
        *************/
                .tooltip {
                    position: relative;
                }

                    .tooltip .tooltiptext {
                        bottom: 100%;
                        left: 50%;
                        margin-left: -60px; /* Use half of the width (120/2 = 60), to center the tooltip */
                        visibility: hidden;
                        /*width: 120px;*/
                        background-color: #ff9800;
                        color: #fff;
                        opacity: 0.8;
                        text-align: center;
                        font-size: 12px;
                        border-radius: 6px;
                        padding: 10px 10px;
                        /* Position the tooltip */
                        position: absolute;
                        z-index: 1;
                    }
    </style>
</head>
<body>
    @*Inicio*@
    <div class="alertify  ajs-movable ajs-closable ajs-pinnable ajs-pulse ajs-maximizable ajs-resizable ajs-basic ajs-maximized">
        <div class="ajs-dimmer"></div><div class="ajs-modal" tabindex="0">
            <div class="ajs-dialog" tabindex="0">
                <button class="ajs-reset"></button><div class="ajs-commands"><button class="ajs-pin"></button><button class="ajs-maximize"></button><button class="ajs-close"></button></div><div class="ajs-header"><h4> <span class="mif-security mif-ani-float mif-ani-slow"></span>...</h4> </div><div class="ajs-body">
                    <div class="ajs-content">
                        @*Contenido*@
                        <div class="formularioresponsive">
                            <div id="titulo">Cambio de contraseña</div>
                            <form id="frmModificarClaveDefecto">
                                <div class="row">
                                    <div class="col-25">
                                        <label>Contraseña actual</label>
                                    </div>
                                    <div class="col-75">
                                        <input type="password" placeholder="Contraseña actual" id="txtPasswordActual">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-25">
                                        <label>Contraseña nueva</label>
                                    </div>
                                    <div class="col-75">
                                        <input type="password" placeholder="Contraseña nueva" id="txtPasswordNueva">
                                        <i>Se requieren 8 caracteres como mínimo y 15 como máximo. Es requerido al menos 1 caracter en mayúsculas, 1 caracter en minúsculas y 1 dígito.</i>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-25">
                                        <label>Confirmar contraseña nueva</label>
                                    </div>
                                    <div class="col-75">
                                        <input type="password" placeholder="Confirmar nueva" id="txtConfirmarPasswordNueva">
                                        <i>Se requieren 8 caracteres como mínimo y 15 como máximo. Es requerido al menos 1 caracter en mayúsculas, 1 caracter en minúsculas y 1 dígito.</i>
                                    </div>
                                </div>
                                <div class="row">
                                    <br>
                                    <input type="button" id="btnSuccess" onclick="ModificarPasswordDefecto()" value="Modificar">
                                </div>
                            </form>
                        </div>
                        @*Contenido*@
                    </div>
                </div><div class="ajs-footer"><div class="ajs-auxiliary ajs-buttons"></div><div class="ajs-primary ajs-buttons"><button class="ajs-button success button">OK</button><button class="ajs-button danger button">Cancel</button></div></div><div class="ajs-handle"></div><button class="ajs-reset"></button>
            </div>
        </div>
    </div>
    @*Fin*@
    

    @using (Html.BeginScriptContext())
    {

        Html.AddScriptFile("~/bundles/jquery");
        Html.AddScriptFile("~/bundles/alertify");

        Html.AddScriptBlock(
            @<script type="text/javascript">

                /*******************************
                    *  Base64 encode / decode
                    *  http://www.webtoolkit.info/
                    ********************************/
                var Base64 = {

                    // private property
                    _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

                    // public method for encoding
                    encode: function (input) {
                        var output = "";
                        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
                        var i = 0;

                        input = Base64._utf8_encode(input);

                        while (i < input.length) {

                            chr1 = input.charCodeAt(i++);
                            chr2 = input.charCodeAt(i++);
                            chr3 = input.charCodeAt(i++);

                            enc1 = chr1 >> 2;
                            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                            enc4 = chr3 & 63;

                            if (isNaN(chr2)) {
                                enc3 = enc4 = 64;
                            } else if (isNaN(chr3)) {
                                enc4 = 64;
                            }

                            output = output +
                            this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                            this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);

                        }

                        return output;
                    },

                    // public method for decoding
                    decode: function (input) {
                        var output = "";
                        var chr1, chr2, chr3;
                        var enc1, enc2, enc3, enc4;
                        var i = 0;

                        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

                        while (i < input.length) {

                            enc1 = this._keyStr.indexOf(input.charAt(i++));
                            enc2 = this._keyStr.indexOf(input.charAt(i++));
                            enc3 = this._keyStr.indexOf(input.charAt(i++));
                            enc4 = this._keyStr.indexOf(input.charAt(i++));

                            chr1 = (enc1 << 2) | (enc2 >> 4);
                            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
                            chr3 = ((enc3 & 3) << 6) | enc4;

                            output = output + String.fromCharCode(chr1);

                            if (enc3 != 64) {
                                output = output + String.fromCharCode(chr2);
                            }
                            if (enc4 != 64) {
                                output = output + String.fromCharCode(chr3);
                            }

                        }

                        output = Base64._utf8_decode(output);

                        return output;

                    },

                    // private method for UTF-8 encoding
                    _utf8_encode: function (string) {
                        string = string.replace(/\r\n/g, "\n");
                        var utftext = "";

                        for (var n = 0; n < string.length; n++) {

                            var c = string.charCodeAt(n);

                            if (c < 128) {
                                utftext += String.fromCharCode(c);
                            }
                            else if ((c > 127) && (c < 2048)) {
                                utftext += String.fromCharCode((c >> 6) | 192);
                                utftext += String.fromCharCode((c & 63) | 128);
                            }
                            else {
                                utftext += String.fromCharCode((c >> 12) | 224);
                                utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                                utftext += String.fromCharCode((c & 63) | 128);
                            }

                        }

                        return utftext;
                    },

                    // private method for UTF-8 decoding
                    _utf8_decode: function (utftext) {
                        var string = "";
                        var i = 0;
                        var c = c1 = c2 = 0;

                        while (i < utftext.length) {

                            c = utftext.charCodeAt(i);

                            if (c < 128) {
                                string += String.fromCharCode(c);
                                i++;
                            }
                            else if ((c > 191) && (c < 224)) {
                                c2 = utftext.charCodeAt(i + 1);
                                string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                                i += 2;
                            }
                            else {
                                c2 = utftext.charCodeAt(i + 1);
                                c3 = utftext.charCodeAt(i + 2);
                                string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                                i += 3;
                            }

                        }

                        return string;
                    }

                }

                function VerClave() {
                    $.each($("input[type=password]"), function (index, value) {
                        //Añadimos la clase password
                        $(value).addClass("password")

                        //Agregamos el div y span al input type password
                        var inputhtml = $('<div />').append($(value).clone()).remove().html();

                        var esqueleto = ""; var ico_id = "icover_" + $(value).attr("id")
                        esqueleto = esqueleto + '<div class="cont-inputpass">';
                        esqueleto = esqueleto + inputhtml;

                        esqueleto = esqueleto + '<span id="' + ico_id + '" class="ico">Ver</span>';
                        esqueleto = esqueleto + '</div>';
                        $(value).replaceWith(esqueleto);

                        var inputPassword = $(value);
                        var icoObj = $("#" + ico_id);

                        //Eventos del icono
                        $(icoObj).on("mousedown", function () {
                            var id = $(value).attr("id");
                            $("#" + id).attr("type", "text");

                            //oculta tooltip
                            ocultarMensajeEmergente($("#spanUsuarioId"));
                            ocultarMensajeEmergente($("#spanPassword"));
                        });

                        $(icoObj).on("mouseup mouseout", function () {
                            var id = $(value).attr("id");
                            $("#" + id).attr("type", "password");
                        });
                    })
                }
                //$("frmModificarClaveDefecto")

                function obtenerURL(sUrl) {
                    var path_name = "";
                    if (sUrl.length <= 0) {
                        console.log("obtenerURL: la URL es un parametro requerido");
                        return;
                    } //Agregar slash en caso de que la url no lo contenga
                    if (sUrl.substr(0, 1) != "/") {
                        sUrl = "/" + sUrl;
                    }

                    if (window.location.pathname != "/") {
                        path_name = window.location.pathname;

                    }
                    // Cuando el sitio este alojado en una ruta distinta al nodo raiz
                    if (path_name.includes("/Usuario/Login")) {
                        path_name = path_name.replace("/Usuario/Login", "");
                    }

                    if (path_name.includes("/Usuario/ModificarPassword")) {
                        path_name = path_name.replace("/Usuario/ModificarPassword", "");
                    }
                    return (path_name + sUrl);
                }

                function mostrarMensajeEmergente(objspan, message) {
                    $(objspan).text(message);
                    $(objspan).css("visibility", "visible");
                }

                function ocultarMensajeEmergente(objspan) {
                    $(objspan).css("visibility", "hidden");
                }

                $(document).ready(function () {
                    //Mostrar contraseña
                    VerClave();
                    //Mostrar contraseña

                    $("#frmModificarClaveDefecto").keydown(function (event) {
                        if ((event.keyCode == 13)) {
                            ModificarPasswordDefecto();
                        }
                    });
                });

                function ModificarPasswordDefecto() {
                    $("#txtPasswordActual").val($("#txtPasswordActual").val().trim());
                    $("#txtPasswordNueva").val($("#txtPasswordNueva").val().trim());
                    $("#txtConfirmarPasswordNueva").val($("#txtConfirmarPasswordNueva").val().trim());

                    //console.log("entro btnok");
                    var passwordactual = $("#txtPasswordActual").val();
                    var passwordnueva = $("#txtPasswordNueva").val();
                    var confirmarpasswordnueva = $("#txtConfirmarPasswordNueva").val();
                    //Obtenemos el string en formato json
                    //var UsuarioJSON = JSON.parse($("#sUsuario").val());
                    var usuarioid = '@ViewBag.UsuarioId';

                    if (passwordactual.length === 0 || passwordnueva.length === 0 || confirmarpasswordnueva.length === 0) {
                        alertify.alert("Advertencia", "Por favor, debe llenar los campos requeridos");
                        return false;
                    }

                    //////////////////////////////////
                    //Utilizamos una expresion regular
                    //Se requiere al menos 1 caracter en mayúsculas, 1 en minúsculas y 1 dígito
                    var reg = /(?=^.{8,15}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$/

                    if (!reg.test(passwordnueva)) {
                        alertify.alert("Advertencia", "La contraseña debe contener al menos 1 caracter en mayúsculas, 1 caracter en minúsculas y 1 dígito!");
                        return false;
                    }
                    /////////////////////////////////
                    passwordactual = Base64.encode(passwordactual);

                    if (passwordnueva.length < 8) {
                        alertify.alert("Advertencia", "La contraseña debe tener al menos 8 caracteres.");
                        return false;
                    }

                    //Comparación contraseña
                    if (passwordnueva === confirmarpasswordnueva) {
                        passwordnueva = Base64.encode(passwordnueva);
    
                        $.get(obtenerURL("/Usuario/CambiarPassword"), { usuarioid: usuarioid, passwordactual: passwordactual, passwordnueva: passwordnueva })
                            .done(function (data) {
                                 var JsonData = $.parseJSON(data)

                                 if (JsonData.Retorno === "0") {
                                     //alertify.alert("Notificación", "Se ha modificado exitosamente su contraseña, se cerrará su sesión de usuario para que ingrese nuevamente");
                                    
                                     alertify.alert("Confirmación", "Se ha modificado exitosamente su contraseña, se cerrará su sesión de usuario para que ingrese nuevamente", function () {
                                        
                                         url = $(location).attr("origin") + obtenerURL("/Usuario/Login");
                                         $(location).attr("href", url);
                                         alertify.confirm().close();
                                         alertify.confirm().destroy();
                                     });
                                     alertify.alert().setting('modal', true);     
                                     
                                     //$.post("Home/CerrarSesion");
                                    
                                 }
                                 else {
                                     alertify.alert("Advertencia", JsonData.Mensaje);
                                 }
                             }).fail(function (jqxhr, textStatus, error) {
                                 var err = textStatus + ", " + error;
                                 alertify.alert("Advertencia", err);
                                 //console.log("Request Failed: " + err);
                             });
                    }
                    else {
                        alertify.alert("Advertencia", "La contraseña nueva y de confirmación deben coincidir!");
                    }
                    //Comparación contraseña
                }

                function MensajeEspera() {
                    var dialog = '<div id="dialogPreloader"><div data-role="preloader" data-type="square" data-style="color" class="preloader-square color-style"><div class="square"></div><div class="square"></div><div class="square"></div><div class="square"></div></div>Por favor, espere un momento...</div>';
                    alertify.alert().set('basic', true).setting({ 'closable': false }).setContent(dialog).show();
                }
            </script>
            , true);

    }
    @Html.RenderScripts(Scripts.Render)
</body>
</html>
